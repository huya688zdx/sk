<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="../../plugins/element-ui/index.css" />
  <link rel="stylesheet" href="../../styles/common.css" />
  <link rel="stylesheet" href="../../styles/page.css" />
  <style>
    .search-btn {
      margin-left: 20px;
    }

    .tableBar {
      justify-content: flex-start !important;
    }

    .info-box {
      margin: -15px -44px 20px;
    }

    .info-box .item-box {
      display: flex;
      height: 20px;
      line-height: 20px;
      font-size: 14px;
      font-weight: 400;
      color: #666666;
      text-align: left;
      margin-bottom: 14px;
    }

    .info-box .item-box:last-child {
      margin-bottom: 0;
    }

    .info-box .item-box .label {
      width: 96px;
    }

    .info-box .item-box .des {
      flex: 1;
      color: #333333;
    }
  </style>
</head>

<body>
  <div class="dashboard-container" id="order-app" v-loading="loading">
    <!-- <div class="tab-change">
      <div
        v-for="item in changedOrderList"
        :key="item.value"
        class="tab-item"
        :class="{ active: item.value === activeIndex }"
        @click="tabChange(item.value)"
      >
        <el-badge
          class="item"
          :class="{ 'special-item': item.num < 10 }"
          :is-hidden="!([2, 3, 4].includes(item.value) && item.num)"
          :value="item.num > 99 ? '99+' : item.num"
        >
          {{ item.label }}
        </el-badge>
      </div>
    </div> -->

    <div class="container" :class="{ hContainer: tableData.length }">
      <div class="tableBar">
        <label style="margin-right: 10px">订单号：</label>
        <el-input style="width: 15%" placeholder="请填写订单号" clearable v-model="input" @clear="init(orderStatus)"
          @keyup.enter="initFun(orderStatus)"></el-input>
        <label style="margin-left: 20px">手机号：</label>
        <el-input style="width: 15%" placeholder="请填写手机号" clearable v-model="phone" @clear="init(orderStatus)"
          @keyup.enter="initFun(orderStatus)"></el-input>
        <label style="margin-left: 20px">下单时间：</label>
        <el-date-picker style="width: 25%; margin-left: 10px" clearable value-format="yyyy-MM-dd HH:mm:ss"
          range-separator="至" :default-time="['00:00:00', '23:59:59']" type="daterange" start-placeholder="开始日期"
          end-placeholder="结束日期" v-model="valueTime" @clear="init(orderStatus)"></el-date-picker>
        <el-button class="normal-btn continue" @click="init(orderStatus, true)">
          查询
        </el-button>
      </div>
      <!-- Rest of the template code -->
    </div>

  </div>
  <!-- 开发环境版本，包含了有帮助的命令行警告 -->
  <script src="../../plugins/vue/vue.js"></script>
  <!-- 引入组件库 -->
  <script src="../../plugins/element-ui/index.js"></script>
  <!-- 引入axios -->
  <script src="../../plugins/axios/axios.min.js"></script>
  <script src="../../js/request.js"></script>
  <script src="../../api/order.js"></script>
  <script>
    new Vue({
      el: '#order-app',
      data() {
        return {
          defaultActivity: 0,
          orderStatics: {},
          row: {},
          isAutoNext: true,
          isTableOperateBtn: true,
          currentPageIndex: 0,
          orderId: '',
          input: '',
          phone: '',
          valueTime: [],
          dialogVisible: false,
          cancelDialogVisible: false,
          cancelDialogTitle: '',
          cancelReason: '',
          remark: '',
          counts: 0,
          page: 1,
          pageSize: 10,
          tableData: [],
          diaForm: [],
          isSearch: false,
          orderStatus: 0,
          dialogOrderStatus: 0,
          cancelOrderReasonList: [
            {
              value: 1,
              label: '订单量较多，暂时无法接单',
            },
            {
              value: 2,
              label: '菜品已销售完，暂时无法接单',
            },
            {
              value: 3,
              label: '餐厅已打烊，暂时无法接单',
            },
            {
              value: 0,
              label: '自定义原因',
            },
          ],
          cancelrReasonList: [
            {
              value: 1,
              label: '订单量较多，暂时无法接单',
            },
            {
              value: 2,
              label: '菜品已销售完，暂时无法接单',
            },
            {
              value: 3,
              label: '骑手不足无法配送',
            },
            {
              value: 4,
              label: '客户电话取消',
            },
            {
              value: 0,
              label: '自定义原因',
            },
          ],
          orderList: [
            {
              label: '全部订单',
              value: 0,
            },
            {
              label: '待付款',
              value: 1,
            },
            {
              label: '待接单',
              value: 2,
            },
            {
              label: '待派送',
              value: 3,
            },
            {
              label: '派送中',
              value: 4,
            },
            {
              label: '已完成',
              value: 5,
            },
            {
              label: '已取消',
              value: 6,
            },
          ],
        };
      },
      watch: {
        orderTime(val) {
          if (val && val.length >= 2) {
            this.beginTime = val[0]
            this.endTime = val[1]
          } else {
            this.beginTime = ''
            this.endTime = ''
          }
        }
      },
      created() {
        this.init(Number(this.$route.query.status) || 0);
      },

      mounted() {
        if (this.$route.query.orderId && this.$route.query.orderId !== 'undefined') {
          this.goDetail(this.$route.query.orderId, 2);
        }
        if (this.$route.query.status) {
          this.defaultActivity = this.$route.query.status;
        }
      },

      methods: {
        initFun(orderStatus) {
          this.page = 1;
          this.init(orderStatus);
        },

        change(activeIndex) {
          if (activeIndex === this.orderStatus) return;
          this.init(activeIndex);
          this.input = '';
          this.phone = '';
          this.valueTime = [];
          this.dialogOrderStatus = 0;
          this.$router.push('/order');
          console.log(activeIndex, '接收到了子组件的index');
        },

        getOrderListBy3Status() {
          getOrderListBy({})
            .then((res) => {
              if (res.data.code === 1) {
                this.orderStatics = res.data.data;
              } else {
                this.$message.error(res.data.msg);
              }
            })
            .catch((err) => {
              this.$message.error('请求出错了：' + err.message);
            });
        },

        init(activeIndex = 0, isSearch) {
          this.isSearch = isSearch;
          const params = {
            page: this.page,
            pageSize: this.pageSize,
            number: this.input || undefined,
            phone: this.phone || undefined,
            beginTime: this.valueTime && this.valueTime.length > 0 ? this.valueTime[0] : undefined,
            endTime: this.valueTime && this.valueTime.length > 0 ? this.valueTime[1] : undefined,
            status: activeIndex || undefined,
          };
          getOrderDetailPage({ ...params })
            .then((res) => {
              if (res.data.code === 1) {
                console.log(res.data);
                this.tableData = res.data.data.records;
                this.orderStatus = activeIndex;
                this.counts = Number(res.data.data.total);
                this.getOrderListBy3Status();
                if (this.dialogOrderStatus === 2 && this.orderStatus === 2 && this.isAutoNext && !this.isTableOperateBtn && res.data.data.records.length > 1) {
                  const row = res.data.data.records[0];
                  this.goDetail(row.id, row.status, row);
                } else {
                  return null;
                }
              } else {
                this.$message.error(res.data.msg);
              }
            })
            .catch((err) => {
              this.$message.error('请求出错了：' + err.message);
            });
        },

        getOrderType(row) {
          if (row.status === 1) {
            return '待付款';
          } else if (row.status === 2) {
            return '待接单';
          } else if (row.status === 3) {
            return '待派送';
          } else if (row.status === 4) {
            return '派送中';
          } else if (row.status === 5) {
            return '已完成';
          } else if (row.status === 6) {
            return '已取消';
          } else {
            return '退款';
          }
        },

        async goDetail(id, status, row) {
          this.diaForm = [];
          this.dialogVisible = true;
          this.dialogOrderStatus = status;
          this.orderId = id;
          const { data } = await queryOrderDetailById({ orderId: id });
          this.diaForm = data.data;
          this.row = row || { id: this.$route.query.orderId, status: status };
          if (this.$route.query.orderId) {
            this.$router.push('/order');
          }
        },

        orderReject(row) {
          this.cancelDialogVisible = true;
          this.orderId = row.id;
          this.dialogOrderStatus = row.status;
          this.cancelDialogTitle = '拒绝';
          this.dialogVisible = false;
          this.cancelReason = '';
        },

        orderAccept(row) {
          this.orderId = row.id;
          this.dialogOrderStatus = row.status;
          orderAccept({ id: this.orderId })
            .then((res) => {
              if (res.data.code === 1) {
                this.$message.success('操作成功');
                this.orderId = '';
                this.dialogVisible = false;
                this.init(this.orderStatus);
              } else {
                this.$message.error(res.data.msg);
              }
            })
            .catch((err) => {
              this.$message.error('请求出错了：' + err.message);
            });
        },

        cancelOrder(row) {
          this.cancelDialogVisible = true;
          this.orderId = row.id;
          this.dialogOrderStatus = row.status;
          this.cancelDialogTitle = '取消';
          this.dialogVisible = false;
          this.cancelReason = '';
        },

        confirmCancel(type) {
          if (!this.cancelReason) {
            return this.$message.error(`请选择${this.cancelDialogTitle}原因`);
          } else if (this.cancelReason === '自定义原因' && !this.remark) {
            return this.$message.error(`请输入${this.cancelDialogTitle}原因`);
          }

          (this.cancelDialogTitle === '取消' ? orderCancel : orderReject)({
            id: this.orderId,
            [this.cancelDialogTitle === '取消' ? 'cancelReason' : 'rejectionReason']: this.cancelReason === '自定义原因' ? this.remark : this.cancelReason,
          })
            .then((res) => {
              if (res.data.code === 1) {
                this.$message.success('操作成功');
                this.cancelDialogVisible = false;
                this.orderId = '';
                this.init(this.orderStatus);
              } else {
                this.$message.error(res.data.msg);
              }
            })
            .catch((err) => {
              this.$message.error('请求出错了：' + err.message);
            });
        },

        cancelOrDeliveryOrComplete(status, id) {
          const params = {
            status,
            id,
          };
          (status === 3 ? deliveryOrder : completeOrder)(params)
            .then((res) => {
              if (res.data.code === 1) {
                this.$message.success('操作成功');
                this.orderId = '';
                this.dialogVisible = false;
                this.init(this.orderStatus);
              } else {
                this.$message.error(res.data.msg);
              }
            })
            .catch((err) => {
              this.$message.error('请求出错了：' + err.message);
            });
        },

        handleClose() {
          this.dialogVisible = false;
        },

        handleSizeChange(val) {
          this.pageSize = val;
          this.init(this.orderStatus);
        },

        handleCurrentChange(val) {
          this.page = val;
          this.init(this.orderStatus);
        }
      }
    })
  </script>
</body>

</html>